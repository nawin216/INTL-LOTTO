<!DOCTYPE html>
<html lang="th">
<head>
  <meta charset="UTF-8">
  <title>ฝาก USDT — INTL LOTTO</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0">

  <!-- Tailwind (ใช้นิดหน่อยเรื่อง flex/text) -->
  <script src="https://cdn.tailwindcss.com"></script>

  <!-- Icons / Fonts -->
  <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.0/css/all.min.css" rel="stylesheet"/>
  <link href="https://fonts.googleapis.com/css2?family=Prompt:wght@300;400;500;600&display=swap" rel="stylesheet">
  <link rel="icon" type="image/png" href="/favicon.png">

  <style>
    * { box-sizing: border-box; }

    body {
      font-family: 'Prompt', sans-serif;
      margin: 0;
      background: linear-gradient(180deg, #e0f2fe 0%, #f3f4f6 40%, #f9fafb 100%);
      color: #111827;
    }

    .page-wrapper {
      max-width: 520px;
      margin: 0 auto;
      padding: 16px 16px 24px;
    }

    .card {
      background: #ffffff;
      border-radius: 20px;
      box-shadow: 0 10px 24px rgba(148,163,184,0.28);
      border: 1px solid #e5e7eb;
      padding: 18px 18px 20px;
      margin-top: 14px;
    }

    /* top info bar */
    .pill-network {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 4px 10px;
      border-radius: 999px;
      background: #eff6ff;
      color: #1d4ed8;
      font-size: 0.75rem;
      font-weight: 500;
      border: 1px solid #bfdbfe;
    }

    .pill-network i {
      font-size: 0.8rem;
    }

    /* ฟอร์ม */
    .form-label {
      display: block;
      font-size: 0.9rem;
      font-weight: 500;
      color: #374151;
      margin-bottom: 4px;
    }

    .form-control {
      width: 100%;
      border-radius: 0.9rem;
      border: 1px solid #d1d5db;
      padding: 9px 12px;
      font-size: 0.9rem;
      outline: none;
      transition: border-color 0.15s ease, box-shadow 0.15s ease, background-color 0.15s ease;
      background-color: #f9fafb;
    }

    .form-control:focus {
      border-color: #0ea5e9;
      box-shadow: 0 0 0 1px rgba(14,165,233,0.35);
      background-color: #ffffff;
    }

    .form-text {
      font-size: 0.75rem;
      color: #6b7280;
      margin-top: 4px;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      border-radius: 999px;
      padding: 9px 22px;
      font-size: 0.9rem;
      font-weight: 500;
      border: none;
      cursor: pointer;
      transition: transform 0.05s ease, box-shadow 0.12s ease, background-color 0.15s ease;
    }

    .btn-success {
      background: linear-gradient(135deg, #0ea5e9, #0284c7);
      color: #fff;
      box-shadow: 0 6px 16px rgba(14,165,233,0.4);
      width: 100%;
    }

    .btn-success:hover {
      background: linear-gradient(135deg, #0284c7, #0369a1);
      transform: translateY(-1px);
      box-shadow: 0 8px 20px rgba(14,165,233,0.5);
    }

    .btn-success:disabled {
      opacity: 0.7;
      cursor: default;
      box-shadow: none;
      transform: none;
    }

    /* ตารางประวัติ */
    .table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.85rem;
    }

    .table th,
    .table td {
      padding: 8px 6px;
      border-bottom: 1px solid #e5e7eb;
      text-align: left;
      vertical-align: middle;
    }

    .table thead th {
      font-weight: 600;
      color: #4b5563;
      font-size: 0.8rem;
      background: #f9fafb;
    }

    .badge {
      display: inline-block;
      padding: 3px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 500;
    }

    .badge-warning {
      background-color: #fef9c3;
      color: #854d0e;
    }

    .badge-success {
      background-color: #dcfce7;
      color: #166534;
    }

    .badge-danger {
      background-color: #fee2e2;
      color: #b91c1c;
    }

    .link-btn {
      font-size: 0.8rem;
      color: #0284c7;
      text-decoration: underline;
    }

    #deposit-alert {
      border-radius: 12px;
      padding: 8px 12px;
      font-size: 0.8rem;
      margin-bottom: 10px;
      display: none;
    }

    #deposit-alert.success {
      background-color: #dcfce7;
      color: #166534;
    }

    #deposit-alert.error {
      background-color: #fee2e2;
      color: #b91c1c;
    }

    #deposit-alert.info {
      background-color: #e0f2fe;
      color: #075985;
    }

    /* Copy msg */
    #copy-msg {
      transition: opacity 0.3s ease;
    }

    @media (max-width: 480px) {
      .page-wrapper { padding: 12px 12px 24px; }
      .card { padding: 16px 16px 18px; }
    }
  </style>

  <script>
    function copyWallet() {
      const address = document.getElementById("wallet-address").innerText.trim();
      navigator.clipboard.writeText(address).then(() => {
        const msg = document.getElementById("copy-msg");
        msg.style.opacity = "1";
        setTimeout(() => (msg.style.opacity = "0"), 1800);
      });
    }
    function goBack(){ window.history.back(); }
  </script>
</head>

<body>

  <!-- Topbar -->
  <div class="bg-sky-600 text-white py-3 px-4 flex items-center gap-3 shadow-md">
    <i class="fas fa-arrow-left text-xl cursor-pointer" onclick="goBack()"></i>
    <div>
      <div class="text-lg font-semibold leading-none">INTL LOTTO</div>
      <div class="text-xs opacity-90 -mt-1">ฝากเงิน</div>
    </div>
  </div>

  <!-- Content -->
  <div class="page-wrapper">

    <!-- ช่องทางฝาก / QR -->
    <div class="card">
      <div class="flex items-center justify-between mb-3">
        <div>
          <p class="text-sm font-semibold text-gray-800">ฝาก USDT ผ่าน QR Code</p>
          <p class="text-xs text-gray-500 mt-1">สแกนด้วยกระเป๋าเงินคริปโตของคุณ</p>
        </div>
        <span class="pill-network">
          <i class="fa-brands fa-btc"></i>
          Tron TRC20
        </span>
      </div>

      <div class="flex flex-col items-center mt-2">
        <div class="rounded-2xl border border-gray-200 bg-white p-3 shadow-sm">
          <img src="/Untitled-1.jpg"
               class="w-44 h-44 sm:w-48 sm:h-48 rounded-xl object-cover"
               alt="Deposit QR Code">
        </div>
        <p class="text-[11px] text-gray-500 mt-2">
          * ตรวจสอบเครือข่ายให้ถูกต้องก่อนโอนทุกครั้ง
        </p>
      </div>

      <!-- ที่อยู่กระเป๋า -->
      <div class="mt-4">
        <p class="text-xs text-gray-500 mb-1">ที่อยู่กระเป๋าฝากเงิน</p>
        <div class="flex items-center gap-2 bg-gray-50 rounded-xl border border-gray-200 px-3 py-2">
          <div id="wallet-address"
               class="text-xs font-medium text-gray-700 truncate">
            TGeiojAWBND6EBJ6sSRoVkBLN2Bhug8bRB
          </div>
          <button onclick="copyWallet()"
                  class="text-sky-600 text-lg px-2 flex-shrink-0">
            <i class="fa-regular fa-copy"></i>
          </button>
        </div>
        <div id="copy-msg"
             class="text-green-500 text-[11px] text-right mt-1 opacity-0">
          ✓ คัดลอกแล้ว
        </div>
      </div>
    </div>

    <!-- หมายเหตุ -->
    <p class="text-center text-gray-500 text-xs mt-3 px-4">
      * ฝากขั้นต่ำ 10 USDT หากยอดไม่อัปเดตภายใน 5 นาที โปรดติดต่อเจ้าหน้าที่
    </p>

    <!-- ฟอร์มแจ้งฝาก -->
    <section class="card mt-3">
      <h5 class="text-base font-semibold mb-2">แจ้งฝากเงินเข้าระบบ</h5>
      <p class="text-xs text-gray-500 mb-3">
        กรุณากรอกจำนวนที่โอนจริงและอัปโหลดสลิป เพื่อให้เจ้าหน้าที่ตรวจสอบและปรับยอด
      </p>

      <div id="deposit-alert" class="info"></div>

      <form id="deposit-form" enctype="multipart/form-data" class="space-y-3">
        <div>
          <label for="deposit-amount" class="form-label">จำนวนเงินที่โอน (USDT)</label>
          <input type="number"
                 class="form-control"
                 id="deposit-amount"
                 name="amount"
                 min="1"
                 step="0.01"
                 placeholder="เช่น 500"
                 required>
          <div class="form-text">
            กรอกตามจำนวนที่โอนจริง หน่วยเป็น USDT
          </div>
        </div>

        <div>
          <label for="deposit-slip" class="form-label">อัปโหลดสลิปโอนเงิน</label>
          <input type="file"
                 class="form-control"
                 id="deposit-slip"
                 name="slip"
                 accept="image/*"
                 required>
          <div class="form-text">
            รองรับไฟล์รูปภาพ ขนาดไม่เกิน 5MB
          </div>
        </div>

        <button type="submit" class="btn btn-success" id="btn-submit-deposit">
          ยืนยันการฝาก
        </button>
      </form>
    </section>

    <!-- ประวัติการฝากเงิน -->
    <section class="card mt-3 mb-6">
      <div class="flex items-center justify-between mb-1">
        <h5 class="text-base font-semibold">ประวัติการฝากเงินของคุณ</h5>
        <span class="text-[11px] text-gray-400">แสดงรายการล่าสุด</span>
      </div>

      <div id="deposit-history-empty" class="text-xs text-gray-500 mb-1 hidden">
        กรุณาเข้าสู่ระบบเพื่อดูประวัติการฝากเงิน
      </div>

      <div class="overflow-x-auto mt-1">
        <table class="table" id="deposit-history-table">
          <thead>
            <tr>
              <th>วันที่</th>
              <th>ยอดฝาก</th>
              <th>สถานะ</th>
              <th>สลิป</th>
            </tr>
          </thead>
          <tbody id="deposit-history-body">
            <!-- เติมด้วย JS -->
          </tbody>
        </table>
      </div>
    </section>

  </div>

  <!-- JS ฝากเงิน + ประวัติ (โค้ดเดิม) -->
  <script>
    const API_BASE = '/api';

    document.addEventListener('DOMContentLoaded', () => {
      const depositForm = document.getElementById('deposit-form');
      depositForm.addEventListener('submit', handleDepositSubmit);

      loadMyDepositHistory();
    });

    function showDepositAlert(message, type = 'info') {
      const box = document.getElementById('deposit-alert');
      box.textContent = message;
      box.classList.remove('success', 'error', 'info');
      box.classList.add(type);
      box.style.display = 'block';
    }

    function hideDepositAlert() {
      const box = document.getElementById('deposit-alert');
      box.style.display = 'none';
      box.textContent = '';
    }

    async function handleDepositSubmit(e) {
      e.preventDefault();
      hideDepositAlert();

      const amountInput = document.getElementById('deposit-amount');
      const slipInput = document.getElementById('deposit-slip');
      const submitBtn = document.getElementById('btn-submit-deposit');

      if (!amountInput.value || Number(amountInput.value) <= 0) {
        showDepositAlert('กรุณากรอกจำนวนเงินฝากให้ถูกต้อง', 'error');
        return;
      }

      if (!slipInput.files[0]) {
        showDepositAlert('กรุณาอัปโหลดรูปสลิปการโอน', 'error');
        return;
      }

      const token = localStorage.getItem('token');
      if (!token) {
        showDepositAlert('ไม่พบ token กรุณาเข้าสู่ระบบใหม่อีกครั้ง', 'error');
        return;
      }

      const confirmMsg = `โปรดยืนยันว่าคุณได้โอนเงินจำนวน ${amountInput.value} USDT เข้ามาแล้ว`;
      const ok = confirm(confirmMsg);
      if (!ok) return;

      const formData = new FormData();
      formData.append('amount', amountInput.value);
      formData.append('slip', slipInput.files[0]);

      submitBtn.disabled = true;
      submitBtn.textContent = 'กำลังส่งคำขอ...';

      try {
        const res = await fetch(`${API_BASE}/deposits`, {
          method: 'POST',
          body: formData,
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        const data = await res.json().catch(() => ({}));

        if (!res.ok) {
          showDepositAlert(data.message || 'มีบางอย่างผิดพลาด กรุณาลองใหม่อีกครั้ง', 'error');
          return;
        }

        showDepositAlert(data.message || 'ส่งคำขอฝากเงินสำเร็จ กรุณารอแอดมินตรวจสอบ', 'success');

        amountInput.value = '';
        slipInput.value = '';

        loadMyDepositHistory();

      } catch (err) {
        console.error(err);
        showDepositAlert('เกิดข้อผิดพลาดในการเชื่อมต่อเซิร์ฟเวอร์', 'error');
      } finally {
        submitBtn.disabled = false;
        submitBtn.textContent = 'ยืนยันการฝาก';
      }
    }

    async function loadMyDepositHistory() {
      const tbody = document.getElementById('deposit-history-body');
      const emptyLabel = document.getElementById('deposit-history-empty');

      tbody.innerHTML = '';
      emptyLabel.classList.add('hidden');

      try {
        const token = localStorage.getItem('token');
        if (!token) {
          emptyLabel.textContent = 'กรุณาเข้าสู่ระบบเพื่อดูประวัติการฝากเงิน';
          emptyLabel.classList.remove('hidden');
          return;
        }

        const res = await fetch(`${API_BASE}/deposits/my`, {
          method: 'GET',
          headers: {
            'Authorization': `Bearer ${token}`,
          },
        });

        if (!res.ok) {
          if (res.status === 401) {
            emptyLabel.textContent = 'กรุณาเข้าสู่ระบบเพื่อดูประวัติการฝากเงิน';
            emptyLabel.classList.remove('hidden');
            return;
          }
          throw new Error('load history failed');
        }

        const deposits = await res.json();

        if (!deposits || deposits.length === 0) {
          emptyLabel.textContent = 'ยังไม่มีประวัติการฝากเงิน';
          emptyLabel.classList.remove('hidden');
          return;
        }

        deposits.forEach(dep => {
          const tr = document.createElement('tr');

          const createdAt = dep.createdAt ? new Date(dep.createdAt) : null;
          const dateStr = createdAt
            ? createdAt.toLocaleString('th-TH', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit',
              })
            : '-';

          let statusBadge = '';
          if (dep.status === 'pending') {
            statusBadge = '<span class="badge badge-warning">รอตรวจสอบ</span>';
          } else if (dep.status === 'approved') {
            statusBadge = '<span class="badge badge-success">สำเร็จ</span>';
          } else if (dep.status === 'rejected') {
            statusBadge = '<span class="badge badge-danger">ไม่สำเร็จ</span>';
          } else {
            statusBadge = `<span class="badge">${dep.status || 'ไม่ทราบสถานะ'}</span>`;
          }

          tr.innerHTML = `
            <td>${dateStr}</td>
            <td>${Number(dep.amount || 0).toLocaleString('th-TH', { minimumFractionDigits: 2, maximumFractionDigits: 2 })}</td>
            <td>${statusBadge}</td>
            <td>
              ${dep.slipUrl
                ? `<a href="${dep.slipUrl}" target="_blank" class="link-btn">ดูสลิป</a>`
                : '-'}
            </td>
          `;

          tbody.appendChild(tr);
        });

      } catch (err) {
        console.error(err);
        emptyLabel.textContent = 'ไม่สามารถโหลดประวัติการฝากเงินได้';
        emptyLabel.classList.remove('hidden');
      }
    }
  </script>

</body>
</html>
