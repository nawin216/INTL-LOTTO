// routes/depositRoutes.js
const express = require('express');
const router = express.Router();

const authenticate = require('../middleware/authenticate');
const Deposit = require('../models/Deposit');
const User = require('../models/User');
const multer = require('multer');
const path = require('path');
const { sendTelegramAlert } = require('../utils/telegram');

// ---------- ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤ multer ‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ ----------
const storage = multer.diskStorage({
  destination: (req, file, cb) => {
    // ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡πÄ‡∏Å‡πá‡∏ö‡∏£‡∏π‡∏õ‡∏™‡∏•‡∏¥‡∏õ (‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏µ‡πÇ‡∏ü‡∏•‡πÄ‡∏î‡∏≠‡∏£‡πå‡∏ô‡∏µ‡πâ‡∏à‡∏£‡∏¥‡∏á‡πÉ‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå)
    cb(null, 'uploads/slips');
  },
  filename: (req, file, cb) => {
    const ext = path.extname(file.originalname);
    const uniqueName = `${Date.now()}-${Math.round(Math.random() * 1e9)}${ext}`;
    cb(null, uniqueName);
  }
});

const upload = multer({
  storage,
  limits: { fileSize: 5 * 1024 * 1024 }, // 5MB
});

// ‡∏ó‡∏∏‡∏Å endpoint ‡πÉ‡∏ô‡πÑ‡∏ü‡∏•‡πå‡∏ô‡∏µ‡πâ‡∏ï‡πâ‡∏≠‡∏á‡∏•‡πá‡∏≠‡∏Å‡∏≠‡∏¥‡∏ô‡∏Å‡πà‡∏≠‡∏ô
router.use(authenticate);

/**
 * POST /api/deposits
 * form-data: { amount, slip (file) }
 * ‡∏ú‡∏π‡πâ‡πÉ‡∏ä‡πâ‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô (status = pending)
 */
router.post('/', upload.single('slip'), async (req, res) => {
  try {
    const { amount } = req.body;
    const file = req.file;

    const numAmount = Number(amount);
    if (!numAmount || numAmount <= 0) {
      return res
        .status(400)
        .json({ success: false, message: '‡∏à‡∏≥‡∏ô‡∏ß‡∏ô‡πÄ‡∏á‡∏¥‡∏ô‡∏ù‡∏≤‡∏Å‡∏ï‡πâ‡∏≠‡∏á‡∏°‡∏≤‡∏Å‡∏Å‡∏ß‡πà‡∏≤ 0' });
    }

    if (!file) {
      return res
        .status(400)
        .json({ success: false, message: '‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏≠‡∏±‡∏õ‡πÇ‡∏´‡∏•‡∏î‡∏™‡∏•‡∏¥‡∏õ‡∏Å‡∏≤‡∏£‡πÇ‡∏≠‡∏ô‡πÄ‡∏á‡∏¥‡∏ô' });
    }

    const slipUrl = `/uploads/slips/${file.filename}`;
    const userId = req.user._id;

    const deposit = await Deposit.create({
      userId,
      amount: numAmount,
      slipUrl,
      status: 'pending',
    });

    // üîî ‡πÅ‡∏à‡πâ‡∏á‡πÄ‡∏ï‡∏∑‡∏≠‡∏ô Telegram ‡πÄ‡∏°‡∏∑‡πà‡∏≠‡∏°‡∏µ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà
    try {
      const user = await User.findById(userId).select('uid email').lean();
      const uid = user?.uid || userId;
      const email = user?.email || '-';

      await sendTelegramAlert(
        `üí∞ ‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÉ‡∏´‡∏°‡πà\n` +
        `UID: ${uid}\n` +
        `Email: ${email}\n` +
        `‡∏¢‡∏≠‡∏î: ${numAmount.toLocaleString('th-TH')} USDT`
      );
    } catch (err) {
      console.error('telegram deposit notify error:', err.message);
    }

    return res.json({
      success: true,
      message: '‡∏™‡πà‡∏á‡∏Ñ‡∏≥‡∏Ç‡∏≠‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢ ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏£‡∏≠‡πÅ‡∏≠‡∏î‡∏°‡∏¥‡∏ô‡∏ï‡∏£‡∏ß‡∏à‡∏™‡∏≠‡∏ö',
      deposit,
    });
  } catch (err) {
    console.error('Create deposit error:', err);
    return res
      .status(500)
      .json({ success: false, message: 'SERVER_ERROR' });
  }
});

/**
 * GET /api/deposits/my
 * ‡∏î‡∏π‡∏õ‡∏£‡∏∞‡∏ß‡∏±‡∏ï‡∏¥‡∏ù‡∏≤‡∏Å‡πÄ‡∏á‡∏¥‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á
 */
router.get('/my', async (req, res) => {
  try {
    const deposits = await Deposit.find({ userId: req.user._id })
      .sort({ createdAt: -1 });

    res.json(deposits);
  } catch (err) {
    console.error('Get my deposits error:', err);
    res.status(500).json({ message: '‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏†‡∏≤‡∏¢‡πÉ‡∏ô‡∏£‡∏∞‡∏ö‡∏ö' });
  }
});

module.exports = router;
